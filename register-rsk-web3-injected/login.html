<html>

<head>
     <title>Secure Sharing of Medical Data</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">
    <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.0.0-beta.36/dist/web3.min.js" integrity="sha256-nWBTbvxhJgjslRyuAKJHK+XcZPlCnmIAAMixz6EefVk=" crossorigin="anonymous"></script>
    <script src="./login.js"></script>
    <link rel="stylesheet" href="login.css">
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.14.1/css/mdb.min.css"
      rel="stylesheet"
    /> 
</head>

<body>
    <div class="container">
        <div class="child">
            <!-- <button id='loginButton' onclick="" class="">
              Login with MetaMask
            </button>
            <p id='userWallet' class='text-lg text-gray-600 my-2'></p>
            <button class="enableEthereumButton">Login with Metamask</button>
            <h2>Account: <span class="showAccount"></span></h2> -->

            <button id='loginButton' onclick="connectWallet()">Login with Metamask</button>
            <p id='userWallet'></p>
            <button id='userRole' onclick="role()">Role</button>
            <p id='userRole'></p>
            <button onClick="dashboardGo">Continue to dashboard..........</button>

        </div>


    </div>
   
      
      <script>

            // const ethereumButton = document.querySelector('.enableEthereumButton');
            // const showAccount = document.querySelector('.showAccount');

            // ethereumButton.addEventListener('click', () => {
            //     getAccount();
            // });

            // async function getAccount() {
            // const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
            // console.log(accounts);
            // const account = accounts[0];
            // showAccount.innerHTML = account;
            // }
                var contract;// = new web3.eth.Contract(abi, contractAddress);

                // Accounts
                var account;
                var abiCenteralDatabase =[
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "userAddress",
				"type": "address"
			}
		],
		"name": "isDoctor",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "userAddress",
				"type": "address"
			}
		],
		"name": "isHospital",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "userAddress",
				"type": "address"
			}
		],
		"name": "isPatient",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "userAddress",
				"type": "address"
			}
		],
		"name": "role",
		"outputs": [
			{
				"internalType": "int256",
				"name": "",
				"type": "int256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "userAddress",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "identityCardAddress",
				"type": "address"
			}
		],
		"name": "updateDoctor",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "userAddress",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "identityCardAddress",
				"type": "address"
			}
		],
		"name": "updateHospital",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "userAddress",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "identityCardAddress",
				"type": "address"
			}
		],
		"name": "updatePatient",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	}
];
                var reply;
                var centralDatabaseContractAddress='0x59E20A3674f673955439f0C48bfe7a9e1ad4969A';
               
                function dashboardGo()
                {
                    if(reply== -1)
                    {
                        window.alert("You are not authorised on this blockchain. Contact Admin.");
                    }
                    else if(reply==0){ location.replace("./Windows/hospital.html");}
                    else if(reply==1){ location.replace("./Widows/doctor.html");}
                    else if(reply==2){ location.replace("./Windows/patient.html");}
                
                }

                function role()
                {
                    reply = -4;
                    contract = new web3.eth.Contract(abiCenteralDatabase, centralDatabaseContractAddress);
                   
                    contract.methods.role(account).call(function (err, res) {
                        if (err) {
                            console.log("An error occured", err)
                            return
                        }
                        console.log("The reply is: ", res)
                        reply = res;
                        console.log(res);
                    })
                    
                    
                }


           
            async function connectWallet() {
            if (window.ethereum) { //check if Metamask is installed
                window.web3 = new Web3(window.ethereum);
                    try {
                        const address = await window.ethereum.enable(); //connect Metamask
                        account = address[0];
                        userWallet.innerText = address[0];
                        loginButton.innerText = 'Retry'
                        console.log(address);
                     
                    } catch (error) {
                        
                        return;
                    }
                    
            } else if (window.web3) {
                window.web3 = new Web3(window.web3.currentProvider)
                // no need to ask for permission
                }else {
                       console.log("ðŸ¦Š You must install Metamask into your browser: https://metamask.io/download.html");      
            } 
            };

        // window.userWalletAddress = null
        // const loginButton = document.getElementById('loginButton')
        // const userWallet = document.getElementById('userWallet')
    
        // function toggleButton() {
        //   if (!window.ethereum) {
        //     loginButton.innerText = 'MetaMask is not installed'
        //     loginButton.classList.remove('bg-purple-500', 'text-white')
        //     loginButton.classList.add('bg-gray-500', 'text-gray-100', 'cursor-not-allowed')
        //     return false
        //   }
    
        //   loginButton.addEventListener('click', loginWithMetaMask)
        // }
    
        // async function loginWithMetaMask() {
        //   const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' })
        //     .catch((e) => {
        //       console.error(e.message)
        //       return
        //     })
        //   if (!accounts) { return }
    
        //   window.userWalletAddress = accounts[0]
        //   userWallet.innerText = window.userWalletAddress
        //   loginButton.innerText = 'Sign out of MetaMask'
    
        //   loginButton.removeEventListener('click', loginWithMetaMask)
        //   setTimeout(() => {
        //     loginButton.addEventListener('click', signOutOfMetaMask)
        //   }, 200)
        // }
    
        // function signOutOfMetaMask() {
        //   window.userWalletAddress = null
        //   userWallet.innerText = ''
        //   loginButton.innerText = 'Sign in with MetaMask'
    
        //   loginButton.removeEventListener('click', signOutOfMetaMask)
        //   setTimeout(() => {
        //     loginButton.addEventListener('click', loginWithMetaMask)
        //   }, 200)
        // }
    
        // window.addEventListener('DOMContentLoaded', () => {
        //   toggleButton()
        // });

       

      </script>
</body>

</html>